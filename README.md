# hotel bookings etl

Make sure to be inside project directory in your terminal

### Initialization

Required only for the first time you are running the project

1. Copy file `example.env` into a new file called `.env` in the same directory
   
2. In `.env` file created, fill in values that have following pattern `<TO BE FILLED>` as needed 

3. Run following to allow helper script execution

```
chmod +x run.sh
```


### Set up

With this step, virtual environment is created (if not exist) and libraries are installed. Also, containers required to execute the project are started. Eventually, transactional database and data warehouse are initialized

```
./run.sh setup
```


### Data generation

Fake data related to hotel reservations e.g. users, rooms, bookings, amenities etc. are generated by running the command below

```
./run.sh datagen
```


### Data population

After running commend below, data generated in previous step is populated to transactional database

```
./run.sh seed
```


### Streaming ETL

In this step, insert, update or delete operations inside transactional database is captured from database log file by connector and sent to kafka broker for further consumption by stream processer. Furthermore, some dimesions namely location and date dimesnions are populated

```
./run.sh etl
```


- Every change in dimension related tables are captured while only latest state of fact related tables are retained in staging tables
- If the command fails because of `AssertionError` or `connection issue`, retry after some time


### Batch Loading

1. Run command below to start airflow scheduler and webserver
```
./run.sh airflow
```

2. After a few minutes, go to `http://localhost:8080/` in web browser then login to airflow website with `AIRFLOW_ADMIN_USERNAME` and `AIRFLOW_ADMIN_PASSWORD` defined in `.env` file
   
3. Turn on the following pipelines or dags
- clean_up
- process_facts
- process_full_picture

4. Optionally, click on any dag name to monitor it while running

Upon successful completion of the pipelines, fact tables and full picture table will be populated. In addition, staging tables will also be cleaned up to reduce storage consumption



### Testing

Fact tables population logic are tested in this step to verify if bookings or amenities data are correctly inserted and if the data are inserted only when less than 7 days is left prior to checkin date

```
./run.sh test
```

Test run is considered as failed when  `AssertionError` is thrown



### Tear down

With this step, containers in use by project are stopped and removed

```
./run.sh down
```

### References

- [wikipedia-activity-diagram](https://en.wikipedia.org/wiki/Activity_diagram)
- [database-diagram-tool](https://dbdiagram.io)
- [data-warehouse-online-course](https://www.udemy.com/share/106qIm/)
- [fake-data-generator-documentation](https://faker.readthedocs.io/en/master/)
- [sql-alchemy-documentation](https://docs.sqlalchemy.org/en/20/)
- [debezium-mysql-documentation](https://debezium.io/documentation/reference/stable/connectors/mysql.html)
- [debezium-mysql-privileges-stackoverflow](https://stackoverflow.com/questions/70658178/how-to-grant-all-mysql-8-0-privileges-to-debezium-in-windows)
- [debezium-avro-documentation](https://debezium.io/documentation/reference/stable/configuration/avro.html)
- [reading-confluent-avro-with-spark](https://medium.com/@mrugankray/real-time-avro-data-analysis-with-spark-streaming-and-confluent-kafka-in-python-426f5e05392d)
- [spark-kafka-integration](https://spark.apache.org/docs/3.4.0/structured-streaming-kafka-integration.html)
- [spark-package-specification](https://stackoverflow.com/questions/54285151/kafka-structured-streaming-kafkasourceprovider-could-not-be-instantiated)
- [pyspark-3.4.0-documentation](https://spark.apache.org/docs/3.4.0/api/python/index.html)
- [install-python-on-alpine-linux](https://stackoverflow.com/a/73294721)
- [guide-for-running-airflow-with-docker](https://stackabuse.com/running-airflow-locally-with-docker-a-technical-guide/)
- [creating-airflow-connections-from-cli](https://airflow.apache.org/docs/apache-airflow/stable/howto/connection.html#creating-a-connection-from-the-cli)
- [airflow-templates-and-macros-documentation](https://airflow.apache.org/docs/apache-airflow/stable/templates-ref.html)
- [airflow-external-task-sensor-documentation](https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/sensors/external_task/index.html#airflow.sensors.external_task.ExternalTaskSensor)
- [working-with-json-data-in-mysql](https://www.digitalocean.com/community/tutorials/working-with-json-in-mysql)
- [unnest-extract-nested-json-data-in-mysql](https://andreessulp.medium.com/how-to-unnest-extract-nested-json-data-in-mysql-8-0-c9322c90df12)
- [booking-dashboard-tableau-public](https://public.tableau.com/views/HotelBookingDemand_16990387653270/bookingdemand?:language=en-US&publish=yes&:display_count=n&:origin=viz_share_link)
- [addon-dashboard-tableau-public](https://public.tableau.com/views/HotelAddonDemand/addondemand?:language=en-US&:display_count=n&:origin=viz_share_link)

